@page "/face/v1.0/persongroups"
@using CognitiveServices.Explorer.Domain.Face
@inject Blazored.LocalStorage.ILocalStorageService localStorage

<h3>IdentityManagement</h3>

<div>
    <label>Face API Key:</label>
    <input type="password" @bind-value="@faceApiKey" />
</div>
<div>
    <label>Base URL:</label>
    <input type="text" @bind-value="@faceApiBaseUrl" />
</div>

<button class="btn btn-primary" @onclick="GetGroups">Get groups (1 TR)</button>

<table border="1">
    <thead>
        <tr>
            <th>Person Group Id</th>
            <th>Name</th>
            <th>Recognition Model</th>
            <th>User Data</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var group in personGroups)
        {
            <tr>
                <td><a href="face/v1.0/persongroups/@group.PersonGroupId/persons">@group.PersonGroupId</a></td>
                <td>@group.Name</td>
                <td>@group.RecogntionModel</td>
                <td>@group.UserData</td>
            </tr>
        }
    </tbody>
</table>

@code {
    string faceApiKey = string.Empty;
    string faceApiBaseUrl = string.Empty;
    string rawJson = string.Empty;
    List<PersonGroupDto> personGroups = new List<PersonGroupDto>();

    protected override async Task OnInitializedAsync()
    {
        faceApiKey = await localStorage.GetItemAsync<string>(nameof(faceApiKey));
        faceApiBaseUrl = await localStorage.GetItemAsync<string>(nameof(faceApiBaseUrl));
    }

    public async Task GetGroups()
    {
        faceApiBaseUrl = faceApiBaseUrl.TrimEnd('/');

        await localStorage.SetItemAsync(nameof(faceApiKey), faceApiKey);
        await localStorage.SetItemAsync(nameof(faceApiBaseUrl), faceApiBaseUrl);

        HttpClient client = new HttpClient();
        client.DefaultRequestHeaders.Add("Ocp-Apim-Subscription-Key", faceApiKey);
        var result = await client.GetAsync(faceApiBaseUrl + "/face/v1.0/persongroups?returnRecognitionModel=true");
        rawJson = await result.Content.ReadAsStringAsync();

        try
        {
            personGroups = Newtonsoft.Json.JsonConvert.DeserializeObject<List<PersonGroupDto>>(rawJson);
        }
        catch
        {
        }
    }
}
